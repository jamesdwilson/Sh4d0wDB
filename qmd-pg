#!/usr/bin/env python3
"""qmd-pg — Drop-in replacement for qmd that queries PG via hybrid search.
Implements: qmd-pg query "text" --json -n N
Also handles: qmd-pg update (no-op), qmd-pg status (returns ok)"""
import json,subprocess,sys,urllib.request,os

P="/opt/homebrew/opt/postgresql@17/bin/psql"
D="shadow"

def emb(q):
    try:
        r=urllib.request.urlopen(urllib.request.Request("http://localhost:11434/api/embeddings",
            json.dumps({"model":"nomic-embed-text","prompt":q}).encode(),
            {"Content-Type":"application/json"}),timeout=8)
        return json.loads(r.read())["embedding"]
    except:return None

def sql(q):
    r=subprocess.run([P,D,"-t","-A","-c",f"SELECT json_agg(row_to_json(sub)) FROM ({q}) sub;"],
        capture_output=True,text=True,timeout=15)
    x=r.stdout.strip()
    return json.loads(x) if x and x!="null" else []

def query(text,n=10):
    eq=text.replace("'","''")
    fts=sql(f"SELECT id,left(COALESCE(content_pyramid,content),1500) as snippet,category,source_file,ts_rank(fts,plainto_tsquery('english','{eq}')) as score FROM memories WHERE fts@@plainto_tsquery('english','{eq}') ORDER BY score DESC LIMIT 50")
    vec=[]
    e=emb(text)
    if e:
        es="["+",".join(str(x) for x in e)+"]"
        vec=sql(f"SELECT id,left(COALESCE(content_pyramid,content),1500) as snippet,category,source_file,1-(embedding<=>'{es}'::vector) as score FROM memories WHERE embedding IS NOT NULL ORDER BY embedding<=>'{es}'::vector LIMIT 50")
    # RRF
    k=60;scores={};cm={}
    for i,r in enumerate(fts):rid=str(r["id"]);scores[rid]=scores.get(rid,0)+1.0/(k+i+1);cm[rid]=r
    for i,r in enumerate(vec):rid=str(r["id"]);scores[rid]=scores.get(rid,0)+1.0/(k+i+1);cm.setdefault(rid,r)
    ranked=sorted(scores.items(),key=lambda x:x[1],reverse=True)[:n]
    results=[]
    for rid,sc in ranked:
        r=cm[rid]
        # qmd protocol: {docid, snippet, score}
        docid=r.get("source_file","") or f"memory-{rid}"
        results.append({"docid":docid,"snippet":r.get("snippet",""),"score":round(sc,6)})
    return results

if __name__=="__main__":
    args=sys.argv[1:]
    if not args or args[0] in["-h","--help"]:
        print("qmd-pg: PG-backed memory search");sys.exit(0)
    cmd=args[0]
    if cmd=="update":
        # no-op — PG is always up to date
        sys.exit(0)
    if cmd=="status":
        print(json.dumps({"status":"ok","backend":"pg","records":6800}))
        sys.exit(0)
    if cmd=="query":
        text=args[1] if len(args)>1 else ""
        n=10
        for i,a in enumerate(args):
            if a=="-n" and i+1<len(args):n=int(args[i+1])
        results=query(text,n)
        print(json.dumps(results))
    else:
        print(json.dumps([]))
