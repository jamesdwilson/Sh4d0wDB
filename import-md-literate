#!/usr/bin/env bash
# import-md — Import agent .md files into ShadowDB with opinionated categorization.
# Usage: ./import-md <workspace-dir> [--dry-run] [--backend postgres|sqlite]
#
# Maps known agent framework files to database tables/categories:
#   SOUL.md, IDENTITY.md   → startup table (injected every session)
#   USER.md                → memories (category: personal)
#   MEMORY.md              → memories (parsed into individual records)
#   BOOTSTRAP.md           → memories (category: ops)
#   TOOLS.md               → skipped (framework-managed)
#   AGENTS.md              → skipped (will be replaced with "DB: m query")
#   *.md                   → memories (auto-categorized)

set -euo pipefail

# --- Config ---
CONFIG_FILE="${SHADOWDB_CONFIG:-$HOME/.shadowdb.json}"
DRY_RUN=false
WORKSPACE=""
BACKEND=""
IMPORTED=0
SKIPPED=0

usage() {
  echo "Usage: $0 <workspace-dir> [--dry-run] [--backend postgres|sqlite]"
  echo ""
  echo "Import agent .md files into ShadowDB."
  echo ""
  echo "Options:"
  echo "  --dry-run     Show what would be imported without writing"
  echo "  --backend     Override backend (default: from ~/.shadowdb.json)"
  exit 1
}

# --- Parse args ---
while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run) DRY_RUN=true; shift ;;
    --backend) BACKEND="$2"; shift 2 ;;
    --help|-h) usage ;;
    *) 
      if [[ -z "$WORKSPACE" ]]; then
        WORKSPACE="$1"; shift
      else
        echo "Error: unexpected argument '$1'" >&2; usage
      fi
      ;;
  esac
done

[[ -z "$WORKSPACE" ]] && usage
WORKSPACE="${WORKSPACE%/}"

if [[ ! -d "$WORKSPACE" ]]; then
  echo "Error: '$WORKSPACE' is not a directory" >&2
  exit 1
fi

# --- Detect backend ---
if [[ -z "$BACKEND" ]] && [[ -f "$CONFIG_FILE" ]]; then
  BACKEND=$(python3 -c "import json; print(json.load(open('$CONFIG_FILE')).get('backend','postgres'))" 2>/dev/null || echo "postgres")
fi
BACKEND="${BACKEND:-postgres}"

# --- Database helpers ---
if [[ "$BACKEND" == "postgres" ]]; then
  DB_NAME=$(python3 -c "import json; print(json.load(open('$CONFIG_FILE')).get('postgres',{}).get('database','shadow'))" 2>/dev/null || echo "shadow")
  PSQL=$(python3 -c "import json; print(json.load(open('$CONFIG_FILE')).get('postgres',{}).get('psql_path','psql'))" 2>/dev/null || echo "psql")
  
  db_exec() { "$PSQL" -q "$DB_NAME" -c "$1"; }
  
  insert_startup() {
    local key="$1" content="$2"
    if $DRY_RUN; then
      echo "  [DRY RUN] INSERT startup: key=$key (${#content} chars)"
      return
    fi
    db_exec "INSERT INTO startup (key, content) VALUES ('$key', \$md\$$content\$md\$)
             ON CONFLICT (key) DO UPDATE SET content = EXCLUDED.content;"
    echo "  ✓ startup.$key (${#content} chars)"
  }
  
  insert_memory() {
    local title="$1" content="$2" category="$3" tags="$4"
    if $DRY_RUN; then
      echo "  [DRY RUN] INSERT memory: $title → $category (${#content} chars)"
      return
    fi
    db_exec "INSERT INTO memories (title, content, category, tags)
             VALUES (\$t\$$title\$t\$, \$c\$$content\$c\$, '$category', '{$tags}');"
    echo "  ✓ $title → $category (${#content} chars)"
  }

elif [[ "$BACKEND" == "sqlite" ]]; then
  DB_PATH=$(python3 -c "import json; print(json.load(open('$CONFIG_FILE')).get('sqlite',{}).get('db_path','$HOME/.shadowdb/shadow.db'))" 2>/dev/null || echo "$HOME/.shadowdb/shadow.db")
  
  db_exec() { sqlite3 "$DB_PATH" "$1"; }
  
  insert_startup() {
    local key="$1" content="$2"
    if $DRY_RUN; then
      echo "  [DRY RUN] INSERT startup: key=$key (${#content} chars)"
      return
    fi
    sqlite3 "$DB_PATH" "INSERT OR REPLACE INTO startup (key, content) VALUES ('$key', '$content');"
    echo "  ✓ startup.$key (${#content} chars)"
  }
  
  insert_memory() {
    local title="$1" content="$2" category="$3" tags="$4"
    if $DRY_RUN; then
      echo "  [DRY RUN] INSERT memory: $title → $category (${#content} chars)"
      return
    fi
    sqlite3 "$DB_PATH" "INSERT INTO memories (title, content, category, tags) VALUES ('$title', '$content', '$category', '$tags');"
    echo "  ✓ $title → $category (${#content} chars)"
  }
else
  echo "Error: unsupported backend '$BACKEND'" >&2
  exit 1
fi

# --- Category mapping ---
# Known framework files → opinionated destinations
file_category() {
  local basename="$1"
  case "$basename" in
    SOUL.md|SOUL.txt)         echo "startup:soul" ;;
    IDENTITY.md|IDENTITY.txt) echo "startup:identity" ;;
    USER.md|USER.txt)         echo "memory:personal:user-profile" ;;
    MEMORY.md|MEMORY.txt)     echo "memory:general:memory-index" ;;
    BOOTSTRAP.md)             echo "memory:ops:bootstrap" ;;
    TOOLS.md)                 echo "skip:framework-managed" ;;
    AGENTS.md)                echo "skip:will-be-replaced" ;;
    HEARTBEAT.md)             echo "skip:will-be-replaced" ;;
    # Common patterns
    *research*)               echo "memory:research:$basename" ;;
    *fitness*|*health*)       echo "memory:fitness:$basename" ;;
    *finance*|*tax*|*budget*) echo "memory:finance:$basename" ;;
    *project*|*plan*)         echo "memory:project:$basename" ;;
    *meeting*|*prep*)         echo "memory:meeting-prep:$basename" ;;
    *contact*|*people*)       echo "memory:contacts:$basename" ;;
    *decision*|*choice*)      echo "memory:decision:$basename" ;;
    *)                        echo "memory:general:$basename" ;;
  esac
}

# --- Main ---
echo "═══════════════════════════════════════"
echo " ShadowDB Import — $BACKEND"
echo " Source: $WORKSPACE"
$DRY_RUN && echo " MODE: DRY RUN (no writes)"
echo "═══════════════════════════════════════"
echo ""

# Find all .md files (top-level + one level deep)
find "$WORKSPACE" -maxdepth 2 -name "*.md" -type f | sort | while read -r filepath; do
  filename=$(basename "$filepath")
  relpath="${filepath#$WORKSPACE/}"
  content=$(cat "$filepath")
  
  # Skip empty files
  if [[ -z "${content// /}" ]] || [[ ${#content} -lt 5 ]]; then
    echo "  ⊘ $relpath (empty/trivial — skipped)"
    SKIPPED=$((SKIPPED + 1))
    continue
  fi
  
  mapping=$(file_category "$filename")
  target="${mapping%%:*}"
  rest="${mapping#*:}"
  
  case "$target" in
    startup)
      key="$rest"
      echo "→ $relpath → startup.$key"
      insert_startup "$key" "$content"
      IMPORTED=$((IMPORTED + 1))
      ;;
    memory)
      category="${rest%%:*}"
      tag="${rest#*:}"
      echo "→ $relpath → memories ($category)"
      insert_memory "$filename" "$content" "$category" "imported,md-import,$tag"
      IMPORTED=$((IMPORTED + 1))
      ;;
    skip)
      reason="$rest"
      echo "  ⊘ $relpath ($reason)"
      SKIPPED=$((SKIPPED + 1))
      ;;
  esac
done

echo ""
echo "═══════════════════════════════════════"
echo " Done."
echo ""
echo " Next steps:"
echo "   1. Verify: m \"test query\""
echo "   2. Zero originals: for f in SOUL.md USER.md MEMORY.md; do echo -n > \"\$f\"; done"
echo "   3. Set AGENTS.md: echo 'DB: m query' > AGENTS.md"
echo "   4. Set HEARTBEAT.md: echo 'm d' > HEARTBEAT.md"
echo "═══════════════════════════════════════"
